---
title: "Statistical Learning Hw3"
author: "Ding Zepeng,18307110088"
date: "2020/10/20"
output:
   html_document:
     toc: yes
---


# 1、读入数据及汇总统计


```{r}
houserent <- read.csv("data.csv", header = T)   # 读入CSV文件
summary(houserent)   # 进行汇总
```


# 2、总体月租金直方图及解读


```{r}
# 绘制月租金分布直方图，适当选取breaks值
hist(houserent$rent, breaks = 30, xlab = "月租金/元", ylab = "频数", main = "月租金分布直方图")
```

+ 解读：总体而言北京市住房月租金（因变量）呈现**右偏分布**，如上图所示。月租金多集中于1800-3400区域，鲜有极高的租金值；根据上一小节汇总统计，月租金中位值为2690元，平均值为2798元，均值略高于中位值也反应出分布的右偏性（少量极高样本值拉高了平均值）。最高的月租金对应朝阳区一间27平米中楼层主卧，附近有地铁、集中供暖：也就是说其优秀的房屋地理位置、面积及房间条件配置等造成了其高昂的月租金。整体情况来看，有75%的住房月租金低于3230元，这个数值是最高月租金6460的一半。


# 3、不同城区租房平均价格分析


```{r}
# 使用聚合函数对平均租金进行按城区的分组统计
meantable <- aggregate(x = houserent$rent, by = list(houserent$region), FUN = mean)
colnames(meantable) <- c("region", "average rent")
# 依照平均租金进行排序，并展示
meantable <- meantable[order(meantable$`average rent`, decreasing = T),]
meantable

# 提取平均租金最高的八组数据并绘制降序柱状图
highdata <- meantable[1:8,]
barplot(highdata[,2], names.arg = highdata[,1], main = "平均租金柱状图", xlab = "region", ylab = "average rent")
```


+ 分析：由租金均值数据及降序柱状图可以看出，**不同城区的月租金均值不同、总体而言越靠近中心/越繁华的城区平均月租金越高**。由降序柱状图可以看出，在平均租金最高的8个城区内：西城区平均租金“独占鳌头”且领先其他城区较多；海淀、朝阳和东城区的月租金相差不多、可认为是“第二梯队”；而石景山、丰台、昌平的平均租金相差不大，但与之前“第二梯队”的城区相差较为明显，可认为是“第三梯队”；通州区的平均月租金较之前城区降低较多，可认为属于“第四梯队”。通州区与西城区的平均月租金差异达到了1450元左右，可以看出不同城区（表征着不同地理位置、经济发展程度）间的平均月租金差异还是比较明显的。


# 4、月租金——城区分组箱线图


```{r fig.width=8}
# 用聚合函数对租金中位值进行按城区分组统计
mediantable <- aggregate(x = houserent$rent, by = list(houserent$region), FUN = median)
colnames(mediantable) <- c("region", "median rent")
mediantable

# 绘制分组箱线图
boxplot(houserent$rent ~ houserent$region, xlab = "region", ylab = "rent", main = "月租金-城区分组箱线图", col = 'blue')
```


+ 分析解读：分组箱线图不仅能看出各城区间月租金中位值的差异，还可以比较不同城区间月租金分布情况的差异。类似上一小节分析，不同城区间的住房月租金相差较为明显，大致上通过中位月租金值可以将城区分为“西城”，“朝阳、东城、海淀”，“石景山、丰台、昌平”，“通州、大兴、顺义、房山”四个梯队，中位月租金水平依次递减，其中月租金中位值最低的房山区(1700元)不足最高的西城区(3800元)的一半。**总体而言，地理位置越靠近城中心、经济越繁华的城区房屋中位月租金越高，与生活经验相符合**。<br>
&emsp;&emsp;此外，根据箱线宽度，可以看出西城、海淀、朝阳的住房月租金在各自城区内的差异也较大，而其他城区内住房月租金分布相对而言比较集中（差异不太大）。推测这种现象是由于靠近中心较为发达的城区内部发展程度、便捷或是福利程度差异较大导致的，比如海淀区的学区房整体而言要比非学区房租金高、高档小区整体而言要比旧居民住宅小区租金高等。另外，除西城、房山外的其他城区月租金都存在少量极端值，比如样本中最高的月租金(6400元)并不是在中位值最高的西城区、而是在朝阳区，且高出该区中位水平(3190元)一倍多。这也说明**月租金高低并不只与城区差异有关，还受到其他很多因素的影响**。
<br>
+ 但是，仅根据目前的描述性分析，并不能断定城区对于住房月租金有着统计学意义上的显著影响，还需要通过回归建模进行客观分析。


# 5、进行线性回归建模


+ 首先建立多元线性回归模型，模型表达式如下：
$$
      Y = \beta_0\  +\beta_1 X_1\ + ... +\ \beta_9 X_9\ + \epsilon \\\
      E(Y) = \beta_0\  +\beta_1 X_1\ + ... +\ \beta_9 X_9\
$$
其中$Y$为因变量rent，其余均为自变量，分别用$X_1\sim X_9$表示.


```{r}
# 按要求为因子类型指定基准组
houserent$room <- factor(houserent$room, levels = c("次卧", "主卧"))
houserent$floor_grp <- factor(houserent$floor_grp, c("低楼层", "高楼层", "中楼层"))
houserent$subway <- factor(houserent$subway, c("否", "是"))
houserent$region <- factor(houserent$region, c("石景山", "昌平", "朝阳", "大兴", "东城", "房山", "丰台", "海淀", "顺义", "通州", "西城"))
houserent$heating <- factor(houserent$heating, c("自采暖", "集中供暖"))

# 以月租金为因变量建模
lm.fit1 <- lm(rent ~ ., data = houserent)
summary(lm.fit1)   # 查看回归结果
```

+ 模型F检验的p值很小，说明**整体而言回归系数显著性较好**；Adjusted R-square为0.6453，模型对因变量（月租金）的解释作用比较明显
<br>
+ 解读：**各定量自变量的回归系数表示在控制其他自变量不变的前提下，因变量（租金）的期望值对于该自变量的敏感程度：回归系数绝对值越大则越敏感**。例如，租赁房间面积（area）的回归系数约为76.7，这表示在控制其他自变量不变的情况下租赁房间每增加1平方米，月租金的期望值会增加76.7元；当定量自变量回归系数为负值时，则表示在模型中因变量期望值与该自变量呈现负相关关系，例如卧室数（bedroom）的回归系数约为-90.6，这表示控制其他自变量不变的情况下租赁房间卧室数每增加一个，月租金期望值会减少90.6元。这是合理的，反映出了租住者希望共同租客更少的偏好。
&emsp;&emsp;对四个定量自变量分析，发现其均对租金期望值有较显著的影响，其中（当控制其他变量不变时）租金期望值对卫生间数（bathroom）最为敏感，且与卫生间数、租赁房间面积正相关，与卧室数、客厅数负相关。从系数正负与大小可以推断，
租住者有希望面积更大、共用卫生间更多、公共租客（反映在卧室数、客厅数）更少的偏好。
+ **各定性变量（对应转换成的哑变量）的回归系数则表示其他自变量不变时，该定性变量取该分类水平时，因变量的值平均比基准组高多少**。例如，城区（region）变量的基准组是石景山区，则昌平区的回归系数57.2则表示其他自变量不变时，昌平区月租金期望值比石景山区高57.2元；而大兴区的回归系数-421.99则表示其他自变量不变时，大兴区月租金期望值比石景山区低421.99元。
&emsp;&emsp;对五个定性自变量分析，可以发现（均以控制其他自变量不变为前提）：房间类型（room）是主卧还是次卧对月租金影响很小；楼层(floor_grp)的差异导致的月租金差异也较小，高、中楼层的月租金期望值比低楼层略低；靠近地铁（subway）对于月租金均值的有较大的正向影响，相对与不靠近地铁的租房月租金均值高出280.5元；月租金的城区间差异较为明显；供暖方式（heating）也有较大影响，集中供暖的月租金期望值比自供暖高出155.8元.
+ 综上所述，房间类型、所在楼层对月租金期望值的影响较小，其他因素则具有一定的影响。
+ 此外，**单个系数假设检验的p值反映了该系数的显著水平**，即对应自变量对因变量解释程度的显著水平；p值越低，该显著性水平越高。
<br><br>

```{r}
 # 进行模型诊断，绘图
par(mfrow = c(2, 2))
plot(lm.fit1, which = c(1:4))
```
<br>
+ 分析：左上角为残差与拟合值的散点图，若因变量和自变量呈现线性相关关系，则残差值与拟合值不会有任何系统关联；图中所示残差并不随拟合值变化而呈现规律性变化，因此**基本满足线性假设**。但左下角的位置尺度图中随着拟合值增大，标准化残差呈现升高的规律，而如果满足同方差假设则水平线周围的点应无规律随机分布，因此表明模型**存在一定的异方差问题**。右上角为正态Q-Q图，模型中残差项在较大值的部分偏离了45°直线，因此**较大程度上偏离了正态分布**。右下角的Cook距离图中样本点的Cook距离均很小，最大值低于0.05（远小于1），因此可认为**样本中不存在强影响点**。
<br>
+ 针对以上问题，可以通过对因变量进行对数变换，重新拟合回归模型，如下。
<br>
<br>
$$
      log(Y) = \beta_0\  +\beta_1 X_1\ + ... +\ \beta_9 X_9\ + \epsilon 
$$
<br>
```{r}
# 将因变量进行对数变换
houserent$logrent <- log(houserent$rent)
# 建立对数线性模型，剔除原rent变量
lm.fitlog <- lm(logrent ~ .-rent, data = houserent)
# 查看回归结果
summary(lm.fitlog)

par(mfrow = c(2, 2))
plot(lm.fitlog, which = c(1:4))    # 进行模型诊断，绘图
```


+ 分析：对数线性拟合模型中，F检验的p值亦较小、调整后的R方略高于线性模型，**整体而言回归系数显著性较好**。根据模型回归诊断图可以看出，**异方差及非正态性都得到了很好的改善**。
+ 系数解读：在对数线性回归模型中，自变量的回归系数所表示的含义与线性模型不同，可以理解为“**增长率**”：<br>
$$
        \partial\ log(y)\ / \partial x = \partial y/(y \times \partial x)
$$
- 对于模型中的四个**定量自变量**而言，其回归系数表示在控制其他自变量不变的同时，该自变量每增加一单位，因变量平均而言增加的比例。对本对数模型而言，控制其他因素不变时：
    -- 每增加一个卧室(表征着共同租客的增加)，月租金平均减少3.68%；
    -- 每增加一间客厅，月租金平均减少4.4%；
    -- 每多一间卫生间，月租金平均增加6.4%；
    -- 租住面积每增加一平米，月租金平均增加2.52%.
- 对于模型中的五个**定性自变量**而言，其回归系数表示其他因素不变的同时，自变量取该分类某个水平时，因变量平均相对于基准水平增加的比例。对本对数模型而言，控制其他因素不变时：
    -- 房间类型主卧比次卧的月租金平均贵0.44%（差异不明显）；
    -- 高楼层房间月租金平均比低楼层低1.05%，中楼层月租金平均比低楼层低2.04%；楼层类型导致的月租金差异较小；
    -- 地铁房比非地铁房的月租金平均高出10.59%；
    -- 城区见平均月租金的差异较为明显，其中西城区平均月租金最高，高出石景山区28.5%；房山区平均月租金最低，相比于石景山区减少了39.58%.
    -- 集中供暖的房间月租金平均比自供暖房间高出4.29%

```{r}
library(DAAG)     # 诊断模型是否有多重共线性
vif(lm.fitlog)

```


+ 模型各自变量的VIF值均低于10，可认为**自变量间不存在多重共线性**。


# 6、应用BIC准则对变量进行选择


```{r}
n <- nrow(houserent)
# BIC准则对线性回归模型进行选择
lm.bic1 <- step(lm.fit1, direction = "both", k = log(n), trace = F)
summary(lm.bic1)
```
<br>
```{r}
# BIC准则对对数线性回归模型进行选择
lm.bic2 <- step(lm.fitlog, direction = "both", k = log(n), trace = F)
summary(lm.bic2)
```


+ 解读：从回归结果可以看出，不论是对线性模型、还是对对数线性模型使用BIC准则进行逐步回归后，**留下的自变量均对因变量有显著的影响（单个系数假设检验的p值较小）**，且两种BIC回归均剔除了livingroom（客厅数）、room（卧室类型）、floor_grp（楼层类型），留下了剩下的自变量。
+ 留下自变量的系数估计值与原模型略有区别，对系数的解读类似之前；用BIC准则进行变量选择后的模型的Adjusted R-square与之前基本相同，模型对因变量（月租金）的解释作用比较明显；模型F检验的p值很小，说明整体而言回归系数显著性较好。


# 7、交叉验证及模型评估


```{r}
## 对BIC准则选择的线性模型进行五折交叉验证
# 使用DAAG包的cv.lm()函数
cv.lm1 <- cv.lm(data = houserent, lm.bic1, m = 5, printit = F, seed = 123)
sqrt(attr(cv.lm1, "ms"))     # 均方根误差

# 自编函数
predcv <- function(dat, k){
  ind = sample(1:k, nrow(dat), replace = T)
  pred_cv = rep(0, nrow(dat))
  for(i in 1:k){
    ii = which(ind == i)
    obj = lm(rent ~ .-logrent, data = dat[-ii,])
    pred_cv[ii] = predict(obj, houserent[ii,])
  }
  rmse = sqrt(mean((pred_cv - dat$rent)^2))
  return(list(pred_cv = pred_cv, rmse = rmse))
}

set.seed = 1234
pred_cv = predcv(dat = houserent, k=5)
pred_cv$rmse
```


+ 解读：通过交叉验证的均方根误差可以看出，经过BIC准则变量选择后的线性模型预测的效果较好（但仍有很大改善空间），预测的均方根误差低于月租金一个数量级，大概是月租金中位数(2690)的17%。


```{r}
# 模型诊断
par(mfrow = c(2, 2))
plot(lm.bic1, which = c(1:4))
```

+ BIC准则进行变量选择后的线性模型评估：
    --左上角为残差与拟合值的散点图，若因变量和自变量呈现线性相关关系，则残差值与拟合值不会有任何系统关联；图中所示残差并不随拟合值变化而呈现规律性变化，因此**基本满足线性假设**。
    --左下角的位置尺度图中随着拟合值增大，标准化残差呈现升高的规律，而如果满足同方差假设则水平线周围的点应无规律随机分布，因此表明模型**存在一定的异方差问题**。
    --右上角为正态Q-Q图，模型中残差项在较大值的部分偏离了45°直线，因此**较大程度上偏离了正态分布**。
    --右下角的Cook距离图中样本点的Cook距离均很小，最大值低于0.05（远小于1），因此可认为**样本中不存在强影响点**。

+ 综上可以看出，BIC变量选择后的线性模型仍存在和之前线性模型类似的问题，可以尝试因变量对数变换后再应用BIC准则，其五折交叉验证及模型结果如下：
<br>

```{r}
## 对BIC准则选择的对数线性模型进行五折交叉验证
# 使用DAAG包的cv.lm()函数
cv.lm1 <- cv.lm(data = houserent, lm.bic2, m = 5, printit = FALSE, seed = 123)
sqrt(attr(cv.lm1, "ms"))       # 均方根误差


# 自编函数
predcv <- function(dat, k){
  ind = sample(1:k, nrow(dat), replace = T)
  pred_cv = rep(0, nrow(dat))
  for(i in 1:k){
    ii = which(ind == i)
    obj = lm(logrent ~ .-rent, data = dat[-ii,])
    pred_cv[ii] = predict(obj, houserent[ii,])
  }
  rmse = sqrt(mean((pred_cv - dat$logrent)^2))
  return(list(pred_cv = pred_cv, rmse = rmse))
}

set.seed = 1234
pred_cv = predcv(dat = houserent, k=5)
pred_cv$rmse


```

+ 解读：通过交叉验证的均方根误差可以看出，经过BIC准则变量选择后的对数线性模型预测的效果较好，略优于相应的线性模型的预测效果，预测的均方根误差低于log(rent)一个数量级，大概是月租金中位数(7.897)的1.9%【但这是对数化后的误差百分比】.

```{r}
# 模型诊断
par(mfrow = c(2, 2))
plot(lm.bic2, which = c(1:4))
```


+ BIC准则进行变量选择后的对数线性模型评估：根据模型回归诊断图可以看出，**异方差及非正态性都得到了很好的改善**，相较于之前的线性模型更优。


